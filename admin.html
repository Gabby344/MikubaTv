<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mikuba TV - Administration des Articles PRO</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* Configuration de base et personnalisation Tailwind */
        :root {
            --primary-color: #B70000; /* Rouge Profond Mikuba */
            --secondary-color: #0F0F10; /* Noir Rich */
            --accent-color: #008CBA; /* Bleu Cyber Électrique (pour les liens/actions) */
            --background-body: #F0F2F5; /* Gris clair de fond professionnel */
        }
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': 'var(--primary-color)',
                        'secondary': 'var(--secondary-color)',
                        'accent': 'var(--accent-color)',
                        'body-bg': 'var(--background-body)',
                        'sophisticated-gray': '#4A4E69', /* Gris utilisé pour le texte secondaire */
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    boxShadow: {
                        'form-card': '0 10px 30px rgba(0, 0, 0, 0.05)',
                        'input-focus': '0 0 0 3px rgba(183, 0, 0, 0.2)', /* Ombre de focus subtile */
                    }
                }
            }
        }
    
        /* Styles CSS natifs pour les ajustements fins non couverts par Tailwind */
        textarea { resize: vertical; min-height: 250px; }
        
        /* Personnalisation de l'apparence du select pour un look plus pro */
        select { 
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23B70000' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 1em;
        }

    </style>
</head>
<body class="bg-body-bg text-secondary antialiased p-5 md:p-10">

    <!-- FIREBASE & LOGIC JS -->
    <script type="module">
        // Import des modules Firebase modernes (v10/v11)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Variables globales Canvas (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mikuba-tv-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let currentUserId = null;
        
        setLogLevel('Debug');

        // Initialisation de Firebase
        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentification
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                onAuthStateChanged(auth, (user) => {
                    currentUserId = user ? user.uid : crypto.randomUUID();
                    console.log(`Firebase initialisé. User ID: ${currentUserId}`);
                    // Activation du bouton si l'authentification est prête
                    document.getElementById('publish-btn').disabled = false;
                });

            } catch (error) {
                console.error("Erreur critique Firebase:", error);
                document.getElementById('status-message').textContent = '❌ Erreur de connexion à la base de données. Vérifiez la console.';
                document.getElementById('status-message').classList.add('error', 'block');
            }
        };

        // Fonction pour obtenir le chemin de collection publique
        const dbPath = (collectionName) => { 
            return `/artifacts/${appId}/public/data/${collectionName}`; 
        };

        /**
         * Fonction de publication d'article vers Firestore.
         */
        window.publishArticle = async (articleData, button, form, statusElement) => {
            if (!db) {
                statusElement.textContent = '❌ Base de données non initialisée.';
                statusElement.className = 'error block';
                return;
            }

            button.disabled = true;
            statusElement.style.display = 'none';

            try {
                // Construction de l'objet de données final
                const dataToSave = {
                    ...articleData,
                    timestamp: Date.now(),
                    views: 0,
                    author: articleData.author || 'Rédaction Mikuba TV',
                    is_featured: false, // Par défaut, non mis en avant
                };
                
                // On utilise addDoc pour laisser Firestore générer l'ID
                const docRef = await addDoc(collection(db, dbPath('news')), dataToSave);

                statusElement.textContent = `✅ Article publié avec succès ! ID: ${docRef.id}`;
                statusElement.className = 'bg-green-100 text-green-700 border border-green-300 p-3 rounded-xl block';
                
                // Réinitialiser le formulaire
                form.reset();
                // Forcer la mise à jour de la prévisualisation après reset
                updatePreview();

            } catch (error) {
                console.error("Erreur de publication:", error);
                statusElement.textContent = `❌ Échec de la publication: ${error.message}`;
                statusElement.className = 'bg-red-100 text-red-700 border border-red-300 p-3 rounded-xl block';
            } finally {
                button.disabled = false;
            }
        };

        // --- Logique de Prévisualisation ---
        const DEFAULT_IMAGE = "https://placehold.co/300x180/E0E0E0/666666?text=Image+de+couverture";

        const updatePreview = () => {
            const inputTitle = document.getElementById('title');
            const inputSummary = document.getElementById('summary');
            const inputImageUrl = document.getElementById('imageUrl');
            const inputCategory = document.getElementById('category');

            const previewTitle = document.getElementById('preview-title');
            const previewSummary = document.getElementById('preview-summary');
            const previewImage = document.getElementById('preview-image');
            const previewCategory = document.getElementById('preview-category');

            // Mise à jour du texte
            previewTitle.textContent = inputTitle.value || "Titre de l'Article...";
            previewSummary.textContent = inputSummary.value || "Le résumé de l'article sera affiché ici pour voir comment il apparaît sur la page d'accueil.";
            previewCategory.textContent = inputCategory.value.toUpperCase() || "SÉLECTIONNER";
            
            // Gestion de l'image (avec onerror)
            const imageUrl = inputImageUrl.value;
            if (imageUrl && imageUrl.startsWith('http')) {
                previewImage.src = imageUrl;
            } else {
                previewImage.src = DEFAULT_IMAGE;
            }
        };
        
        // --- Initialisation au chargement du DOM ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebase();

            const form = document.getElementById('article-form');
            const statusMessage = document.getElementById('status-message');
            const btn = document.getElementById('publish-btn');
            const inputTitle = document.getElementById('title');
            const inputSummary = document.getElementById('summary');
            const inputImageUrl = document.getElementById('imageUrl');
            const inputCategory = document.getElementById('category');

            // Événement d'erreur pour l'image de prévisualisation
            document.getElementById('preview-image').onerror = (e) => {
                e.target.src = DEFAULT_IMAGE;
            };

            // Ajouter des écouteurs d'événements pour la prévisualisation en direct
            [inputTitle, inputSummary, inputImageUrl, inputCategory].forEach(el => {
                el.addEventListener('input', updatePreview);
                el.addEventListener('change', updatePreview); // Pour le <select>
            });

            // Gestion de l'événement de Soumission
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const newArticleData = {
                    title: inputTitle.value,
                    author: document.getElementById('author').value || 'Rédaction Mikuba TV',
                    category: inputCategory.value,
                    summary: inputSummary.value,
                    imageUrl: inputImageUrl.value,
                    content: document.getElementById('body').value, // Renommé 'body' en 'content' pour la cohérence
                };

                // Appel à la fonction globale de publication
                window.publishArticle(newArticleData, btn, form, statusMessage);
            });
            
            // Initialisation de l'aperçu au chargement
            updatePreview();
        });
    </script>


    <div class="max-w-7xl mx-auto">
        <h1 class="text-4xl font-extrabold text-primary mb-2 flex items-center">
            <svg class="w-8 h-8 mr-3 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4h-8a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-2m-2-2h2m-2 0h-2m0 0v2m0 0h2m-2 0h-2m0 0v2m0 0h2m-2 0h-2m0 0v2m0 0h2m-2 0h-2m0 0v2m0 0h2"></path></svg>
            Tableau de Bord - Publication d'Articles
        </h1>
        <p class="text-xl text-sophisticated-gray mb-6">Créez et prévisualisez votre nouvelle actualité pour Mikuba TV.</p>
        
        <p class="mb-6">
            <a href="index.html" class="text-accent font-semibold flex items-center hover:text-primary transition-colors duration-200">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Retour à l'accueil du site
            </a>
        </p>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 bg-white p-6 md:p-10 rounded-2xl shadow-form-card">
            
            <!-- SECTION FORMULAIRE (2/3 sur desktop) -->
            <div class="lg:col-span-2">
                <form id="article-form">
                    <!-- Champ Titre -->
                    <div class="mb-6">
                        <label for="title" class="block mb-2 font-bold text-lg text-sophisticated-gray">Titre de l'Article <span class="text-primary">*</span></label>
                        <input type="text" id="title" placeholder="Titre principal impactant (max. 100 chars)" maxlength="100" required
                               class="w-full p-3 border border-gray-300 rounded-xl text-lg transition duration-300 focus:border-primary focus:shadow-input-focus">
                    </div>
                    
                    <!-- Champ Résumé -->
                    <div class="mb-6">
                        <label for="summary" class="block mb-2 font-bold text-lg text-sophisticated-gray">Résumé (pour la carte d'accueil - max. 160 chars) <span class="text-primary">*</span></label>
                        <input type="text" id="summary" placeholder="Description courte pour accrocher le lecteur." maxlength="160" required
                               class="w-full p-3 border border-gray-300 rounded-xl text-lg transition duration-300 focus:border-primary focus:shadow-input-focus">
                    </div>

                    <!-- Champ URL Image -->
                    <div class="mb-6">
                        <label for="imageUrl" class="block mb-2 font-bold text-lg text-sophisticated-gray">URL de l'Image de Couverture <span class="text-primary">*</span></label>
                        <input type="url" id="imageUrl" placeholder="Ex: https://votresite.com/images/article1.jpg" required
                               class="w-full p-3 border border-gray-300 rounded-xl text-lg transition duration-300 focus:border-primary focus:shadow-input-focus">
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                        <!-- Champ Catégorie -->
                        <div class="mb-6">
                            <label for="category" class="block mb-2 font-bold text-lg text-sophisticated-gray">Catégorie <span class="text-primary">*</span></label>
                            <select id="category" required
                                    class="w-full p-3 border border-gray-300 rounded-xl text-lg transition duration-300 focus:border-primary focus:shadow-input-focus">
                                <option value="" disabled selected>Sélectionnez une catégorie</option>
                                <option value="POLITIQUE">Politique</option>
                                <option value="ÉCONOMIE">Économie</option>
                                <option value="SOCIAL">Social</option>
                                <option value="SPORT">Sport</option>
                                <option value="SÉCURITÉ">Sécurité</option>
                                <option value="CULTURE">Culture</option>
                                <option value="INTERNATIONAL">International</option>
                            </select>
                        </div>
                        
                        <!-- Champ Auteur -->
                        <div class="mb-6">
                            <label for="author" class="block mb-2 font-bold text-lg text-sophisticated-gray">Auteur</label>
                            <input type="text" id="author" value="Rédaction Mikuba TV" placeholder="Nom du journaliste"
                                   class="w-full p-3 border border-gray-300 rounded-xl text-lg transition duration-300 focus:border-primary focus:shadow-input-focus">
                        </div>
                    </div>
                    
                    <!-- Champ Corps de l'Article -->
                    <div class="mb-6">
                        <label for="body" class="block mb-2 font-bold text-lg text-sophisticated-gray">Corps de l'Article (Contenu intégral) <span class="text-primary">*</span></label>
                        <textarea id="body" placeholder="Commencez à rédiger ici. Utilisez des balises HTML de base (<h2>, <p>, <ul>, <strong>) pour la mise en forme." required
                                  class="w-full p-4 border border-gray-300 rounded-xl text-lg transition duration-300 focus:border-primary focus:shadow-input-focus"></textarea>
                    </div>

                    <!-- Bouton Publier -->
                    <button type="submit" id="publish-btn" disabled
                            class="w-full bg-primary text-white font-extrabold py-4 px-6 rounded-xl text-xl uppercase tracking-wider 
                                   shadow-lg shadow-primary/50 transition duration-300 transform hover:bg-red-700 hover:scale-[1.005] 
                                   disabled:bg-gray-400 disabled:shadow-none disabled:cursor-not-allowed disabled:transform-none">
                        <span id="publish-text">Connexion DB...</span>
                    </button>
                </form>

                <!-- Message de statut (Success/Error) -->
                <div id="status-message" class="mt-6 p-4 rounded-xl font-semibold text-center hidden"></div>
            </div>

            <!-- SECTION PRÉVISUALISATION EN DIRECT (1/3 sur desktop, Sticky) -->
            <div class="lg:col-span-1 p-5 lg:p-6 bg-body-bg rounded-2xl shadow-inner border-t-8 border-accent lg:h-fit lg:sticky lg:top-10">
                <h2 class="text-2xl font-black text-accent mb-6 pb-2 border-b-2 border-accent/50 text-center">Aperçu de la Carte</h2>
                
                <div class="bg-white rounded-xl overflow-hidden shadow-xl border border-gray-200">
                    <img id="preview-image" src="https://via.placeholder.com/300x180/E0E0E0/666666?text=Image+de+couverture" 
                         alt="Aperçu de l'image" class="w-full h-48 object-cover bg-gray-200"
                         onerror="this.onerror=null;this.src='https://placehold.co/300x180/E0E0E0/666666?text=Image+de+couverture'">
                    
                    <div class="p-4 md:p-5">
                        <p class="text-xs font-bold text-gray-500 mb-1.5 flex justify-between items-center">
                            <span id="preview-category" class="uppercase text-primary">SÉLECTIONNER</span> 
                            <span>Aujourd'hui</span>
                        </p>
                        <h3 id="preview-title" class="text-xl font-extrabold text-secondary mb-3 min-h-[50px] line-clamp-2">Titre de l'Article...</h3>
                        <p id="preview-summary" class="text-sm text-sophisticated-gray line-clamp-3 min-h-[60px]">Le résumé de l'article sera affiché ici pour voir comment il apparaît sur la page d'accueil.</p>
                    </div>
                </div>

                <p class="text-sm text-center text-gray-500 mt-4 italic">Ceci est un aperçu de la carte affichée sur la page d'accueil.</p>
            </div>
        </div>
    </div>

</body>
</html>
